{
  "name": "Daily Report Generator",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "notes": "æ¯å¤©æ—©ä¸Š8ç‚¹è§¦å‘"
    },
    {
      "parameters": {
        "functionCode": "// ç”ŸæˆæŠ¥å‘Šæ—¥æœŸèŒƒå›´\nconst now = new Date();\nconst yesterday = new Date(now);\nyesterday.setDate(yesterday.getDate() - 1);\n\nreturn {\n  json: {\n    reportDate: yesterday.toISOString().split('T')[0],\n    startTime: new Date(yesterday.setHours(0, 0, 0, 0)).toISOString(),\n    endTime: new Date(yesterday.setHours(23, 59, 59, 999)).toISOString(),\n    reportTitle: `æ—¥æŠ¥ - ${yesterday.toISOString().split('T')[0]}`\n  }\n};"
      },
      "id": "prepare-dates",
      "name": "Prepare Dates",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "url": "={{$env.API_URL}}/analytics/summary",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "start_date",
              "value": "={{$json.startTime}}"
            },
            {
              "name": "end_date",
              "value": "={{$json.endTime}}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-analytics",
      "name": "Fetch Analytics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        680,
        300
      ],
      "notes": "è·å–åˆ†ææ•°æ®"
    },
    {
      "parameters": {
        "url": "={{$env.API_URL}}/sales/daily",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "date",
              "value": "={{$node['Prepare Dates'].json.reportDate}}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-sales",
      "name": "Fetch Sales",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        680,
        480
      ],
      "notes": "è·å–é”€å”®æ•°æ®"
    },
    {
      "parameters": {
        "mode": "mergeByPosition"
      },
      "id": "merge-data",
      "name": "Merge Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        900,
        390
      ]
    },
    {
      "parameters": {
        "functionCode": "// åˆå¹¶æ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Š\nconst items = $input.all();\nconst dateInfo = $node['Prepare Dates'].json;\nconst analytics = items[0].json;\nconst sales = items[1].json;\n\n// è®¡ç®—å…³é”®æŒ‡æ ‡\nconst totalRevenue = sales.total_revenue || 0;\nconst totalOrders = sales.total_orders || 0;\nconst avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;\n\nconst pageViews = analytics.page_views || 0;\nconst uniqueVisitors = analytics.unique_visitors || 0;\nconst conversionRate = uniqueVisitors > 0 ? ((totalOrders / uniqueVisitors) * 100).toFixed(2) : 0;\n\n// ç”ŸæˆæŠ¥å‘Šæ–‡æœ¬\nconst reportText = `\nğŸ“Š ${dateInfo.reportTitle}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° é”€å”®æ¦‚å†µ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ æ€»æ”¶å…¥: Â¥${totalRevenue.toLocaleString()}\nâ€¢ è®¢å•æ•°: ${totalOrders}\nâ€¢ å¹³å‡è®¢å•é¢: Â¥${avgOrderValue}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ˆ æµé‡ç»Ÿè®¡\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ é¡µé¢æµè§ˆé‡: ${pageViews.toLocaleString()}\nâ€¢ ç‹¬ç«‹è®¿å®¢: ${uniqueVisitors.toLocaleString()}\nâ€¢ è½¬åŒ–ç‡: ${conversionRate}%\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“… æŠ¥å‘Šæ—¥æœŸ: ${dateInfo.reportDate}\nâ° ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;\n\n// ç”ŸæˆHTMLæ ¼å¼æŠ¥å‘Š\nconst reportHTML = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }\n    h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }\n    .metric-box { background: #ecf0f1; padding: 15px; margin: 10px 0; border-radius: 5px; }\n    .metric-title { font-weight: bold; color: #34495e; margin-bottom: 5px; }\n    .metric-value { font-size: 24px; color: #3498db; }\n    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #bdc3c7; color: #7f8c8d; }\n  </style>\n</head>\n<body>\n  <h1>${dateInfo.reportTitle}</h1>\n  \n  <h2>ğŸ’° é”€å”®æ¦‚å†µ</h2>\n  <div class=\"metric-box\">\n    <div class=\"metric-title\">æ€»æ”¶å…¥</div>\n    <div class=\"metric-value\">Â¥${totalRevenue.toLocaleString()}</div>\n  </div>\n  <div class=\"metric-box\">\n    <div class=\"metric-title\">è®¢å•æ•°</div>\n    <div class=\"metric-value\">${totalOrders}</div>\n  </div>\n  <div class=\"metric-box\">\n    <div class=\"metric-title\">å¹³å‡è®¢å•é¢</div>\n    <div class=\"metric-value\">Â¥${avgOrderValue}</div>\n  </div>\n  \n  <h2>ğŸ“ˆ æµé‡ç»Ÿè®¡</h2>\n  <div class=\"metric-box\">\n    <div class=\"metric-title\">é¡µé¢æµè§ˆé‡</div>\n    <div class=\"metric-value\">${pageViews.toLocaleString()}</div>\n  </div>\n  <div class=\"metric-box\">\n    <div class=\"metric-title\">ç‹¬ç«‹è®¿å®¢</div>\n    <div class=\"metric-value\">${uniqueVisitors.toLocaleString()}</div>\n  </div>\n  <div class=\"metric-box\">\n    <div class=\"metric-title\">è½¬åŒ–ç‡</div>\n    <div class=\"metric-value\">${conversionRate}%</div>\n  </div>\n  \n  <div class=\"footer\">\n    <p>æŠ¥å‘Šæ—¥æœŸ: ${dateInfo.reportDate}</p>\n    <p>ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  json: {\n    reportText: reportText,\n    reportHTML: reportHTML,\n    metrics: {\n      revenue: totalRevenue,\n      orders: totalOrders,\n      avgOrderValue: avgOrderValue,\n      pageViews: pageViews,\n      uniqueVisitors: uniqueVisitors,\n      conversionRate: conversionRate\n    },\n    reportDate: dateInfo.reportDate,\n    generatedAt: new Date().toISOString()\n  }\n};"
      },
      "id": "generate-report",
      "name": "Generate Report",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1120,
        390
      ]
    },
    {
      "parameters": {
        "chatId": "={{$env.TELEGRAM_REPORT_CHAT_ID}}",
        "text": "={{$json.reportText}}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-telegram",
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "={{$env.REPORT_EMAIL_FROM}}",
        "toEmail": "={{$env.REPORT_EMAIL_TO}}",
        "subject": "={{$json.reportTitle}}",
        "emailType": "html",
        "message": "={{$json.reportHTML}}",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [
        1340,
        480
      ],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP"
        }
      }
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Prepare Dates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Dates": {
      "main": [
        [
          {
            "node": "Fetch Analytics",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Sales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Analytics": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Sales": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Generate Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Report": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "automation",
      "id": "1"
    },
    {
      "name": "reporting",
      "id": "2"
    },
    {
      "name": "scheduled",
      "id": "3"
    }
  ],
  "meta": {
    "instanceId": "learning-project"
  },
  "id": "daily-report-generator",
  "versionId": "1.0.0",
  "notes": "æ¯æ—¥è‡ªåŠ¨ç”Ÿæˆä¸šåŠ¡æŠ¥å‘Š\n\nåŠŸèƒ½ï¼š\n- æ¯å¤©æ—©ä¸Š8ç‚¹è‡ªåŠ¨è§¦å‘\n- ä»APIè·å–é”€å”®å’Œåˆ†ææ•°æ®\n- åˆå¹¶æ•°æ®ç”ŸæˆæŠ¥å‘Š\n- åŒæ—¶å‘é€Telegramæ¶ˆæ¯å’Œé‚®ä»¶\n\nå­¦ä¹ è¦ç‚¹ï¼š\n1. Schedule Trigger - å®šæ—¶ä»»åŠ¡\n2. å¹¶è¡ŒAPIè°ƒç”¨æé«˜æ•ˆç‡\n3. MergeèŠ‚ç‚¹åˆå¹¶æ•°æ®\n4. FunctionèŠ‚ç‚¹å¤„ç†å¤æ‚é€»è¾‘\n5. å¤šæ¸ é“é€šçŸ¥ï¼ˆTelegram + Emailï¼‰\n6. HTMLæ ¼å¼æŠ¥å‘Šç”Ÿæˆ\n\nç¯å¢ƒå˜é‡é…ç½®ï¼š\nAPI_URL=https://api.example.com\nTELEGRAM_REPORT_CHAT_ID=your_chat_id\nREPORT_EMAIL_FROM=reports@example.com\nREPORT_EMAIL_TO=team@example.com\n\næ‰©å±•å»ºè®®ï¼š\n- æ·»åŠ å›¾è¡¨ç”Ÿæˆ\n- è¿æ¥æ•°æ®åº“å­˜å‚¨å†å²æ•°æ®\n- æ·»åŠ å¼‚å¸¸æ£€æµ‹å’Œå‘Šè­¦\n- æ”¯æŒæ›´å¤šæŠ¥å‘Šæ ¼å¼ï¼ˆPDFç­‰ï¼‰"
}
